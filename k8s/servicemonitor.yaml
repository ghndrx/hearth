# ServiceMonitor for Prometheus Operator to scrape Hearth metrics
# Requires prometheus-operator to be installed in the cluster
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: hearth-backend
  namespace: hearth
  labels:
    app: hearth
    component: backend
    release: prometheus  # Match your Prometheus release label selector
spec:
  selector:
    matchLabels:
      app: hearth
      component: backend
  namespaceSelector:
    matchNames:
      - hearth
  endpoints:
    - port: http
      path: /metrics
      interval: 15s
      scrapeTimeout: 10s
      honorLabels: true
      # Relabel to add pod name as instance label
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: instance
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node
---
# PodMonitor alternative (if Service doesn't expose metrics port)
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: hearth-backend-pods
  namespace: hearth
  labels:
    app: hearth
    component: backend
spec:
  selector:
    matchLabels:
      app: hearth
      component: backend
  namespaceSelector:
    matchNames:
      - hearth
  podMetricsEndpoints:
    - port: http
      path: /metrics
      interval: 15s
      scrapeTimeout: 10s
---
# PrometheusRule for alerting on WebSocket metrics
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: hearth-websocket-alerts
  namespace: hearth
  labels:
    app: hearth
    prometheus: k8s
    role: alert-rules
spec:
  groups:
    - name: hearth-websocket
      rules:
        # Alert if too many active connections per pod
        - alert: HearthHighConnectionCount
          expr: hearth_websocket_connections_active > 5000
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High WebSocket connection count on {{ $labels.instance }}"
            description: "Pod {{ $labels.instance }} has {{ $value }} active WebSocket connections."

        # Alert if connection count is growing rapidly
        - alert: HearthConnectionSpike
          expr: rate(hearth_websocket_connections_total[5m]) > 100
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: "Rapid WebSocket connection spike on {{ $labels.instance }}"
            description: "Connection rate is {{ $value | humanize }}/s on {{ $labels.instance }}."

        # Alert if message latency is high
        - alert: HearthHighMessageLatency
          expr: histogram_quantile(0.95, rate(hearth_websocket_message_latency_seconds_bucket[5m])) > 0.5
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High WebSocket message latency on {{ $labels.instance }}"
            description: "p95 message latency is {{ $value | humanizeDuration }} on {{ $labels.instance }}."

        # Alert if no connections (might indicate issues)
        - alert: HearthNoConnections
          expr: hearth_websocket_connections_active == 0
          for: 10m
          labels:
            severity: info
          annotations:
            summary: "No active WebSocket connections on {{ $labels.instance }}"
            description: "Pod {{ $labels.instance }} has no active WebSocket connections for 10 minutes."
