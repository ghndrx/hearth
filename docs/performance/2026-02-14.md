# Performance Test Results - 2026-02-14

## Executive Summary

⚠️ **ALERT: Critical Issue Found** - Token validation failing after registration (401 errors on authenticated endpoints)

Performance testing partially blocked by aggressive rate limiting. Baseline metrics collected; issues identified.

## Test Environment

- **Host**: gateway-01 (Linux 6.8.0-100-generic x64)
- **Stack**: Docker Compose (PostgreSQL 16, Redis 7, Go backend)
- **Tool**: k6 v1.6.0

## Baseline Latencies (Single Request)

| Endpoint | Status | Latency | Notes |
|----------|--------|---------|-------|
| GET /health | ✅ 200 | ~1ms | Excellent |
| POST /auth/register | ✅ 201 | ~220ms | Includes bcrypt hashing |
| POST /auth/login | ✅ 200 | ~216ms | Includes bcrypt verification |
| Protected endpoints | ❌ 401 | <1ms | Token validation failure (see issues) |

## Load Test Results

### Auth Endpoints (Target: 100 req/s)

```
Duration: 60s
Total Requests: 8,936
Successful: ~1%
Failed: ~99% (rate limiting)

Latency:
  - p50: 0.5ms
  - p90: 0.7ms  
  - p95: 64ms
  - p99: 2.38s (bcrypt contention under load)

Thresholds:
  ✓ p(95) < 300ms
  ✗ p(99) < 500ms (FAILED - 2.38s)
  ✗ errors < 1% (FAILED - 99%)
```

**Root Cause**: `APIAuth` rate limit is 5 requests/minute per IP. Load testing from single IP triggers immediate rate limiting.

### Under-Load Bcrypt Latency

When concurrent registration requests hit the server, password hashing latency explodes:
- Single request: ~220ms
- Under load: 2.8-3.9 seconds per registration

This indicates bcrypt cost factor may be too high for expected traffic, OR worker pool for CPU-bound operations is undersized.

## Rate Limiting Configuration

Current limits (from `/internal/ratelimit/limiter.go`):

| Action | Limit | Window | Impact |
|--------|-------|--------|--------|
| APIAuth | 5 | 1 min | **Blocks load testing** |
| APIDefault | 100 | 1 min | |
| MessageSend | 5 | 5 sec | |
| ServerCreate | 10 | 1 hour | |

## Critical Issues

### 1. Token Validation Failure (P0)

**Symptom**: Fresh access tokens from registration immediately return 401 "invalid token" on protected endpoints.

**Steps to Reproduce**:
```bash
# Register
curl -X POST http://localhost:8080/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.local","username":"test","password":"TestPass123!"}'
# Response: 201 with access_token

# Immediate authenticated request
curl http://localhost:8080/api/v1/users/@me \
  -H "Authorization: Bearer <token>"
# Response: 401 {"error":"invalid token"}
```

**Impact**: Cannot test any authenticated endpoints.

**Recommended Action**: Investigate JWT validation middleware. Check:
- JWT secret consistency between token issuance and validation
- Token parsing errors in middleware
- Redis session store sync

### 2. Bcrypt Latency Under Load (P1)

Registration latency increases 15x under load (220ms → 3.3s average).

**Recommended Actions**:
- Consider reducing bcrypt cost factor for development/testing
- Implement bcrypt worker pool with bounded concurrency
- Add async registration with job queue for high-traffic scenarios

### 3. Rate Limiting Blocks Testing (P2)

Current rate limits are production-appropriate but block load testing.

**Recommended Actions**:
- Add `DISABLE_RATE_LIMIT` env var for testing
- Or: whitelist 127.0.0.1/localhost from rate limits in dev mode

## Tests Not Run

Due to token validation failure, the following tests were blocked:

- ❌ Message creation load test (500 req/s target)
- ❌ WebSocket concurrent connections test (1000 connections target)
- ❌ Any authenticated endpoint testing

## Optimization Tasks Created

1. **[BUG] Investigate token validation failure on fresh registration**
   - Priority: P0
   - Assignee: Backend team
   
2. **[PERF] Add bcrypt worker pool for bounded CPU usage**
   - Priority: P1
   - Rationale: Prevent latency explosion under auth load

3. **[TEST] Add rate limit bypass for local testing**
   - Priority: P2
   - Suggestion: `RATE_LIMIT_ENABLED=false` env var

## Next Steps

1. Fix token validation issue
2. Re-run full load test suite
3. Target metrics:
   - Auth endpoints: 100 req/s, p99 < 500ms, error rate < 1%
   - Message creation: 500 req/s, p99 < 500ms, error rate < 1%
   - WebSocket: 1000 concurrent, connect p99 < 2s

---
*Test artifacts: `tests/performance/auth-results.json`*
*Generated by automated performance testing cron job*
